<div class="file-management-container">
  <!-- Error Display -->
  <div *ngIf="error" class="error-message">
    <div class="flex items-center p-3 sm:p-4 mb-4 text-red-800 border border-red-300 rounded-lg bg-red-50">
      <img src="assets/icons/lucide/lucide/alert-triangle.svg" alt="error" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" />
      <span class="text-sm sm:text-base">{{ error }}</span>
      <button (click)="clearError()" class="ml-auto text-red-600 hover:text-red-800">
        <img src="assets/icons/lucide/lucide/x.svg" alt="close" class="w-4 h-4" />
      </button>
    </div>
  </div>

  <!-- Test Buttons for Debugging -->
  <div class="test-section mb-4">
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-yellow-800 mb-3">ðŸ§ª Download Testing</h3>
      <div class="flex flex-wrap gap-2">
        <button 
          (click)="testBasicDownload()"
          class="px-3 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm">
          Test Basic Download
        </button>
        <button 
          *ngFor="let file of files.slice(0, 2)"
          (click)="testFileDownload(file)"
          class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
          Test Download: {{ file.originalName }}
        </button>
        <button 
          *ngFor="let file of files.slice(0, 2)"
          (click)="checkFileIntegrity(file)"
          class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
          Check Integrity: {{ file.originalName }}
        </button>
      </div>
      <p class="text-sm text-yellow-700 mt-2">
        Use these buttons to test different download methods and check file integrity.
      </p>
    </div>
  </div>

  <!-- File Upload Component -->
  <div *ngIf="showUpload" class="upload-section mb-4 sm:mb-6">
    <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Upload Files</h3>
    <app-file-upload
      [entityType]="entityType"
      [entityId]="entityId"
      (fileUploaded)="onFileUploaded($event)"
      (uploadError)="error = $event">
    </app-file-upload>
  </div>

  <!-- Filters -->
  <div *ngIf="showFilters" class="filters-section mb-4 sm:mb-6">
    <div class="bg-white rounded-lg border p-3 sm:p-4">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Filters</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Category</label>
          <select 
            [(ngModel)]="filters.category" 
            (change)="onFilterChange()"
            class="w-full px-2 py-1 sm:px-3 sm:py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            <option *ngFor="let category of categories" [value]="category.value">
              {{ category.label }}
            </option>
          </select>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Status</label>
          <select 
            [(ngModel)]="filters.approvalStatus" 
            (change)="onFilterChange()"
            class="w-full px-2 py-1 sm:px-3 sm:py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            <option *ngFor="let status of approvalStatuses" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>
        <div class="flex items-end">
          <button 
            (click)="loadFiles()"
            class="w-full px-3 py-1 sm:px-4 sm:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            <img src="assets/icons/lucide/lucide/refresh-cw.svg" alt="refresh" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1 sm:mr-2" />
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div *ngIf="showActions && files.length > 0" class="bulk-actions mb-4">
    <div class="bg-white rounded-lg border p-3 sm:p-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
        <div class="flex items-center space-x-3 sm:space-x-4">
          <label class="flex items-center">
            <input 
              type="checkbox" 
              [(ngModel)]="selectAll"
              (change)="toggleSelectAll()"
              class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-2 text-xs sm:text-sm text-gray-700">Select All</span>
          </label>
          <span *ngIf="selectedFiles.length > 0" class="text-xs sm:text-sm text-gray-600">
            {{ selectedFiles.length }} file(s) selected
          </span>
        </div>
        <div *ngIf="selectedFiles.length > 0" class="flex flex-wrap gap-1 sm:gap-2">
          <button 
            (click)="bulkDelete()"
            class="px-2 py-1 sm:px-3 sm:py-1 text-red-600 border border-red-300 rounded hover:bg-red-50 text-xs sm:text-sm">
            <img src="assets/icons/lucide/lucide/trash-2.svg" alt="delete" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1" />
            Delete
          </button>
          <button 
            *ngIf="isAdmin"
            (click)="bulkApprove(true)"
            class="px-2 py-1 sm:px-3 sm:py-1 text-green-600 border border-green-300 rounded hover:bg-green-50 text-xs sm:text-sm">
            <img src="assets/icons/lucide/lucide/check.svg" alt="approve" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1" />
            Approve
          </button>
          <button 
            *ngIf="isAdmin"
            (click)="bulkApprove(false)"
            class="px-2 py-1 sm:px-3 sm:py-1 text-red-600 border border-red-300 rounded hover:bg-red-50 text-xs sm:text-sm">
            <img src="assets/icons/lucide/lucide/x.svg" alt="reject" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1" />
            Reject
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Files List -->
  <div class="files-section">
    <div class="bg-white rounded-lg border">
      <!-- Header -->
      <div class="px-3 py-3 sm:px-6 sm:py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900">
            Files ({{ totalFiles }})
          </h3>
          <div *ngIf="loading" class="flex items-center text-gray-600">
            <img src="assets/icons/lucide/lucide/loader-2.svg" alt="loading" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 animate-spin" />
            <span class="text-xs sm:text-sm">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Files Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th *ngIf="showActions" class="px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <input 
                  type="checkbox" 
                  [(ngModel)]="selectAll"
                  (change)="toggleSelectAll()"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </th>
              <th class="px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                File
              </th>
              <th class="px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Category
              </th>
              <th class="hidden sm:table-cell px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Size
              </th>
              <th class="px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
              <th class="hidden md:table-cell px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Uploaded
              </th>
              <th *ngIf="showActions" class="px-1 py-1 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let file of files" class="hover:bg-gray-50">
              <td *ngIf="showActions" class="px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap">
                <input 
                  type="checkbox" 
                  [checked]="selectedFiles.includes(file._id)"
                  (change)="toggleFileSelection(file._id)"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </td>
              <td class="px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <img [src]="getFileIcon(file.extension)" alt="file type" class="w-6 h-6 sm:w-8 sm:h-8 mr-2 sm:mr-3 flex-shrink-0" />
                  <div class="min-w-0 flex-1">
                    <div class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ file.originalName }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ file.uploadedBy.firstName }} {{ file.uploadedBy.lastName }}</div>
                    <div class="text-xs text-gray-500 sm:hidden">{{ formatFileSize(file.size) }}</div>
                  </div>
                </div>
              </td>
              <td class="px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap">
                <span class="inline-flex px-1 py-0.5 sm:px-2 sm:py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                  {{ file.category | titlecase }}
                </span>
              </td>
              <td class="hidden sm:table-cell px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">
                {{ formatFileSize(file.size) }}
              </td>
              <td class="px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap">
                <span class="inline-flex px-1 py-0.5 sm:px-2 sm:py-1 text-xs font-semibold rounded-full"
                      [class]="'status-' + file.approvalStatus">
                  {{ file.approvalStatus | titlecase }}
                </span>
              </td>
              <td class="hidden md:table-cell px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">
                {{ file.createdAt | date:'short' }}
              </td>
              <td *ngIf="showActions" class="px-1 py-1 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">
                <div class="flex space-x-1 sm:space-x-2">
                  <button 
                    (click)="downloadFile(file)"
                    class="text-blue-600 hover:text-blue-900"
                    title="Download">
                    <img src="assets/icons/lucide/lucide/download.svg" alt="download" class="w-3 h-3 sm:w-4 sm:h-4" />
                  </button>
                  <button 
                    *ngIf="isAdmin && file.approvalStatus === 'pending'"
                    (click)="approveFile(file, true)"
                    class="text-green-600 hover:text-green-900"
                    title="Approve">
                    <img src="assets/icons/lucide/lucide/check.svg" alt="approve" class="w-3 h-3 sm:w-4 sm:h-4" />
                  </button>
                  <button 
                    *ngIf="isAdmin && file.approvalStatus === 'pending'"
                    (click)="approveFile(file, false)"
                    class="text-red-600 hover:text-red-900"
                    title="Reject">
                    <img src="assets/icons/lucide/lucide/x.svg" alt="reject" class="w-3 h-3 sm:w-4 sm:h-4" />
                  </button>
                  <button 
                    (click)="deleteFile(file)"
                    class="text-red-600 hover:text-red-900"
                    title="Delete">
                    <img src="assets/icons/lucide/lucide/trash-2.svg" alt="delete" class="w-3 h-3 sm:w-4 sm:h-4" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && files.length === 0" class="text-center py-8 sm:py-12">
        <img src="assets/icons/lucide/lucide/folder-open.svg" alt="no files" class="w-8 h-8 sm:w-12 sm:h-12 mx-auto text-gray-400 mb-3 sm:mb-4" />
        <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-1 sm:mb-2">No files found</h3>
        <p class="text-sm text-gray-500">Upload some files to get started.</p>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="totalPages > 1" class="pagination-section mt-4 sm:mt-6">
    <app-pagination
      [currentPage]="currentPage"
      [totalPages]="totalPages"
      [totalItems]="totalFiles"
      (pageChange)="onPageChange($event)">
    </app-pagination>
  </div>
</div> 